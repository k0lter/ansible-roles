{% if ansible_prolog -%}
{% from 'templates/ansible/prolog.j2' import prolog with context %}
{{ prolog() }}
{% endif -%}
# Nginx vhost for Web Stats

server {
{% if webstats_vhostip or webstats_vhostport %}
    listen {% if webstats_vhostip %}{{ webstats_vhostip }}{% endif %}{% if webstats_vhostip and webstats_vhostport %}:{% endif %}{% if webstats_vhostport %}{{ webstats_vhostport }}{% endif %};
{% endif %}

    server_name {{ webstats_vhostname }};

    access_log  /var/log/nginx/sys.access.log main;
    error_log   /var/log/nginx/sys.error.log;

{% if webstats_ssl %}
    include letsencrypt;
{% endif %}

{% if webstats_ssl and ssl_certs_auto_installed.stdout_lines is defined and webstats_vhostname in ssl_certs_auto_installed.stdout_lines %}
    location / {
        return 301 https://{{ webstats_vhostname }}$request_uri;
    }
{% else %}
    root {{ webstats_docroot }};

    autoindex on;
    autoindex_exact_size off;

    auth_basic "Restricted Access";
    auth_basic_user_file /etc/nginx/auth_admin;
{% endif %}
}
{% if webstats_ssl and ssl_certs_auto_installed.stdout_lines is defined and webstats_vhostname in ssl_certs_auto_installed.stdout_lines %}

server {
    listen {% if webstats_vhostip %}{{ webstats_vhostip }}:{% endif %}{% if webstats_vhostport %}{{ webstats_vhostport }}{% else %}443{% endif %} ssl;

    server_name {{ webstats_vhostname }};

    include vhost_ssl_auto-{{ webstats_vhostname }};

    access_log  /var/log/nginx/sys.access.log main;
    error_log   /var/log/nginx/sys.error.log;

    root {{ webstats_docroot }};

    autoindex on;
    autoindex_exact_size off;

    auth_basic "Restricted Access";
    auth_basic_user_file /etc/nginx/auth_admin;
}
{% endif %}
