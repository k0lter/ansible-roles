{% if ansible_controlled is defined and ansible_controlled != "" %}
#
# {{ ansible_controlled }}
#
{% endif %}
# Nginx vhost for phpmyadmin

server {
    listen {% if phpmyadmin_vhostip %}{{ phpmyadmin_vhostip }}:{% endif %}{{ phpmyadmin_vhostport }};
{% if phpmyadmin_vhostip6 %}
    listen {% if phpmyadmin_vhostip6 %}{{ phpmyadmin_vhostip6 }}:{% endif %}{{ phpmyadmin_vhostport }};
{% endif %}

    server_name {{ phpmyadmin_vhostname }};

    access_log  /var/log/nginx/pma.access.log main;
    error_log   /var/log/nginx/pma.error.log;

{% if phpmyadmin_ssl %}
    include letsencrypt;
{% endif %}

{% if phpmyadmin_ssl and ssl_certs_auto_installed.stdout_lines is defined and phpmyadmin_vhostname in ssl_certs_auto_installed.stdout_lines %}
    location / {
        return 301 https://{{ phpmyadmin_vhostname }}$request_uri;
    }
{% else %}
    root {{ phpmyadmin_rootdir }};
    index index.php;
    try_files $uri $uri/ /index.php;

{% if phpmyadmin_http_auth or phpmyadmin_http_whitelist_ip|length > 0 %}
    location / {
{% if phpmyadmin_http_auth %}
        auth_basic "Restricted Access";
        auth_basic_user_file /etc/nginx/auth_admin;
{% endif %}
{% if phpmyadmin_http_whitelist_ip|length > 0 %}
{% for ip in phpmyadmin_http_whitelist_ip %}
        allow {{ ip }};
{% endfor %}
        deny all;
{% endif %}
{% if phpmyadmin_http_auth and phpmyadmin_http_whitelist_ip|length > 0 %}
        satisfy any;
{% endif %}
    }
{% endif %}

    client_max_body_size 128m;

    location ~ \.php(/|$) {
        include fastcgi_pass_fpm;
        fastcgi_read_timeout 300s;
{% if nginx_fpm_openbasedir_enforced %}
        fastcgi_param PHP_ADMIN_VALUE "upload_tmp_dir=/tmp\nopen_basedir=$document_root:/etc/phpmyadmin:/var/lib/phpmyadmin:/tmp:/usr/share:/tmp:/dev/random:/dev/urandom\nmax_execution_time=300\nupload_max_filesize=128M\npost_max_size=128M\nmax_input_vars=100000";
{% else %}
        fastcgi_param PHP_ADMIN_VALUE "max_execution_time=240\nupload_max_filesize=128M\npost_max_size=128M\nmax_input_vars=100000";
{% endif %}
    }
{% endif %}
}
{% if phpmyadmin_ssl and ssl_certs_auto_installed.stdout_lines is defined and phpmyadmin_vhostname in ssl_certs_auto_installed.stdout_lines %}

server {
    listen {% if phpmyadmin_vhostip %}{{ phpmyadmin_vhostip }}:{% endif %}{{ phpmyadmin_vhostport_ssl }} ssl;
{% if with_http3 %}
    listen {% if phpmyadmin_vhostip %}{{ phpmyadmin_vhostip }}:{% endif %}{{ phpmyadmin_vhostport_ssl }} quic;
{% endif %}
{% if phpmyadmin_vhostip6 %}
    listen {% if phpmyadmin_vhostip6 %}{{ phpmyadmin_vhostip6 }}:{% endif %}{{ phpmyadmin_vhostport_ssl }} ssl;
{% if with_http3 %}
    listen {% if phpmyadmin_vhostip6 %}{{ phpmyadmin_vhostip6 }}:{% endif %}{{ phpmyadmin_vhostport_ssl }} quic;
{% endif %}
{% endif %}
{% if with_http3 %}
    http2 on;
    http3 on;
{% endif %}

    server_name {{ phpmyadmin_vhostname }};

    include vhost_ssl_auto-{{ phpmyadmin_vhostname }};

    access_log  /var/log/nginx/pma.access.log main;
    error_log   /var/log/nginx/pma.error.log;

{% if with_http3 %}
    add_header Alt-Svc 'h3=":$server_port"; ma=3600;';
{% endif %}

    root {{ phpmyadmin_rootdir }};
    index index.php;
    try_files $uri $uri/ /index.php;

{% if phpmyadmin_http_auth or phpmyadmin_http_whitelist_ip|length > 0 %}
{% if phpmyadmin_http_auth %}
    auth_basic "Restricted Access";
    auth_basic_user_file /etc/nginx/auth_admin;
{% endif %}
{% if phpmyadmin_http_whitelist_ip|length > 0 %}
{% for ip in phpmyadmin_http_whitelist_ip %}
    allow {{ ip }};
{% endfor %}
    deny all;
{% endif %}
{% if phpmyadmin_http_auth and phpmyadmin_http_whitelist_ip|length > 0 %}
    satisfy any;
{% endif %}
{% endif %}

    client_max_body_size 128m;

    location ~ \.php(/|$) {
        include fastcgi_pass_fpm;
        fastcgi_read_timeout 300s;
{% if nginx_fpm_openbasedir_enforced %}
        fastcgi_param PHP_ADMIN_VALUE "upload_tmp_dir=/tmp\nopen_basedir=$document_root:/etc/phpmyadmin:/var/lib/phpmyadmin:/tmp:/usr/share:/tmp:/dev/random:/dev/urandom\nmax_execution_time=300\nupload_max_filesize=128M\npost_max_size=128M\nmax_input_vars=100000";
{% else %}
        fastcgi_param PHP_ADMIN_VALUE "max_execution_time=240\nupload_max_filesize=128M\npost_max_size=128M\nmax_input_vars=100000";
{% endif %}
    }
}
{% endif %}
