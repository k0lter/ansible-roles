- name: 'Install Zabbix agent'
  apt:
    pkg:
      - 'zabbix-agent'
    state: 'present'
  when: with_zabbix_agent|bool and not with_zabbix_agent2|bool
  tags:
    - 'monitoring'
    - 'zabbix'

- name: 'Uninstall Zabbix agent'
  apt:
    pkg:
      - 'zabbix-agent'
    state: 'absent'
  when: with_zabbix_agent|bool and with_zabbix_agent2|bool
  tags:
    - 'monitoring'
    - 'zabbix'

- name: 'Install Zabbix agent2'
  apt:
    pkg:
      - 'zabbix-agent2'
    state: 'latest'
  when: with_zabbix_agent2|bool
  tags:
    - 'monitoring'
    - 'zabbix'

- name: 'Install Zabbix agent config file'
  template:
    src: 'zabbix/agent.conf.j2'
    dest: '/etc/zabbix/zabbix_agentd.conf'
    owner: 'root'
    group: 'root'
    mode: '0644'
  when: with_zabbix_agent|bool
  notify:
    - 'Restart zabbix agent'
  tags:
    - 'monitoring'
    - 'zabbix'

- name: 'Install Zabbix agent 2 config file'
  template:
    src: 'zabbix/agent2.conf.j2'
    dest: '/etc/zabbix/zabbix_agent2.conf'
    owner: 'root'
    group: 'root'
    mode: '0644'
  when: with_zabbix_agent2|bool
  notify:
    - 'Restart zabbix agent 2'
  tags:
    - 'monitoring'
    - 'zabbix'

- name: 'Create zabbix plugins configuration directory'
  file:
    path: '/etc/zabbix/zabbix_plugins.conf.d'
    owner: 'root'
    group: 'root'
    mode: '0755'
    state: 'directory'
  when: with_zabbix_agent|bool or with_zabbix_agent2|bool
  tags:
    - 'monitoring'
    - 'zabbix'

- name: 'Install zabbix plugins configuration (ssl, web availability)'
  template:
    src: 'zabbix/plugins/{{ item }}.j2'
    dest: '/etc/zabbix/zabbix_plugins.conf.d/{{ item }}.yml'
    owner: 'root'
    group: 'root'
    mode: '0644'
  when: with_zabbix_agent|bool or with_zabbix_agent2|bool
  with_items:
    - 'ssl-discovery'
    - 'web-availability-discovery'
  tags:
    - 'monitoring'
    - 'zabbix'

# vim: ft=yaml.ansible
