- name: 'Install Zabbix agent'
  apt:
    pkg: '{{ item }}'
    state: 'installed'
    update_cache: 'yes'
  with_items:
    - 'zabbix-agent'

- name: 'Install Zabbix agent config file'
  template:
    src: 'zabbix/agent.conf.j2'
    dest: '/etc/zabbix/zabbix_agentd.conf'
    owner: 'root'
    group: 'root'
    mode: '0600'
  notify:
    - 'Restart zabbix agent'

- name: 'Create zabbix plugins configuration directory'
  file:
    path: '/etc/zabbix/zabbix_plugins.conf.d'
    owner: 'root'
    group: 'root'
    mode: '0755'
    state: 'directory'
  when: zabbix_plugins_config

- name: 'Install zabbix plugins configuration (ssl, web availability)'
  template:
    src: 'zabbix/plugins/{{ item }}.j2'
    dest: '/etc/zabbix/zabbix_plugins.conf.d/{{ item }}.yml'
    owner: 'root'
    group: 'root'
    mode: '0644'
  with_items:
    - 'ssl-discovery'
    - 'web-availability-discovery'
  when: zabbix_plugins_config
